#!/bin/bash

# Theme switcher for Tokyo Night light and dark variants
# Updates: Ghostty, tmux, FZF (zshrc), and provides nvim command

ZSHRC="$HOME/.zshrc"
TMUX_CONF="$HOME/.tmux.conf"
GHOSTTY_CONF="$HOME/.config/ghostty/config"
NVIM_INIT="$HOME/.config/nvim/init.lua"

# Light theme values (Tokyo Night Day)
LIGHT_GHOSTTY='theme = "tokyonight-day"'
LIGHT_TMUX_MODE='set -g mode-style "fg=#3760bf,bg=#b7c1e3"'
LIGHT_TMUX_MSG='set -g message-style "fg=#3760bf,bg=#e1e2e7"'
LIGHT_TMUX_MSG_CMD='set -g message-command-style "fg=#3760bf,bg=#e1e2e7"'
LIGHT_TMUX_PANE='set -g pane-border-style "fg=#a1a6c5"'
LIGHT_TMUX_PANE_ACTIVE='set -g pane-active-border-style "fg=#2e7de9"'
LIGHT_TMUX_STATUS='set -g status-style "fg=#3760bf,bg=#e1e2e7"'
LIGHT_TMUX_WIN='setw -g window-status-style "fg=#2e7de9,bg=#e1e2e7"'
LIGHT_TMUX_WIN_CUR='setw -g window-status-current-style "fg=#e1e2e7,bg=#2e7de9"'
LIGHT_TMUX_WIN_ACT='setw -g window-status-activity-style "fg=#e1e2e7,bg=#9854f1"'
LIGHT_FZF='    --color=bg+:#b7c1e3,bg:#e1e2e7,spinner:#9854f1,hl:#f52a65 \
    --color=fg:#3760bf,header:#2e7de9,info:#2e7de9,pointer:#f52a65 \
    --color=marker:#007197,fg+:#3760bf,prompt:#f52a65,hl+:#f52a65 \
    --color=selected-bg:#b7c1e3 \
    --color=border:#a1a6c5,label:#3760bf"'

# Dark theme values (Tokyo Night)
DARK_GHOSTTY='theme = "tokyonight-moon"'
DARK_TMUX_MODE='set -g mode-style "fg=#c8d3f5,bg=#2d3f76"'
DARK_TMUX_MSG='set -g message-style "fg=#c8d3f5,bg=#222436"'
DARK_TMUX_MSG_CMD='set -g message-command-style "fg=#c8d3f5,bg=#222436"'
DARK_TMUX_PANE='set -g pane-border-style "fg=#444a73"'
DARK_TMUX_PANE_ACTIVE='set -g pane-active-border-style "fg=#82aaff"'
DARK_TMUX_STATUS='set -g status-style "fg=#c8d3f5,bg=#222436"'
DARK_TMUX_WIN='setw -g window-status-style "fg=#82aaff,bg=#222436"'
DARK_TMUX_WIN_CUR='setw -g window-status-current-style "fg=#222436,bg=#82aaff"'
DARK_TMUX_WIN_ACT='setw -g window-status-activity-style "fg=#222436,bg=#c099ff"'
DARK_FZF='    --color=bg+:#2d3f76,bg:#222436,spinner:#c099ff,hl:#ff757f \
    --color=fg:#c8d3f5,header:#82aaff,info:#82aaff,pointer:#ff757f \
    --color=marker:#86e1fc,fg+:#c8d3f5,prompt:#ff757f,hl+:#ff757f \
    --color=selected-bg:#2d3f76 \
    --color=border:#444a73,label:#c8d3f5"'

usage() {
    echo "Usage: theme [light|dark]"
    echo ""
    echo "Switches between Tokyo Night light and dark variants."
    echo "Updates Ghostty, tmux, FZF, and nvim configs."
    exit 1
}

switch_theme() {
    local mode=$1

    if [[ "$mode" == "light" ]]; then
        GHOSTTY="$LIGHT_GHOSTTY"
        TMUX_MODE="$LIGHT_TMUX_MODE"
        TMUX_MSG="$LIGHT_TMUX_MSG"
        TMUX_MSG_CMD="$LIGHT_TMUX_MSG_CMD"
        TMUX_PANE="$LIGHT_TMUX_PANE"
        TMUX_PANE_ACTIVE="$LIGHT_TMUX_PANE_ACTIVE"
        TMUX_STATUS="$LIGHT_TMUX_STATUS"
        TMUX_WIN="$LIGHT_TMUX_WIN"
        TMUX_WIN_CUR="$LIGHT_TMUX_WIN_CUR"
        TMUX_WIN_ACT="$LIGHT_TMUX_WIN_ACT"
        FZF="$LIGHT_FZF"
        NVIM_SCHEME="tokyonight-day"
    elif [[ "$mode" == "dark" ]]; then
        GHOSTTY="$DARK_GHOSTTY"
        TMUX_MODE="$DARK_TMUX_MODE"
        TMUX_MSG="$DARK_TMUX_MSG"
        TMUX_MSG_CMD="$DARK_TMUX_MSG_CMD"
        TMUX_PANE="$DARK_TMUX_PANE"
        TMUX_PANE_ACTIVE="$DARK_TMUX_PANE_ACTIVE"
        TMUX_STATUS="$DARK_TMUX_STATUS"
        TMUX_WIN="$DARK_TMUX_WIN"
        TMUX_WIN_CUR="$DARK_TMUX_WIN_CUR"
        TMUX_WIN_ACT="$DARK_TMUX_WIN_ACT"
        FZF="$DARK_FZF"
        NVIM_SCHEME="tokyonight-moon"
    else
        usage
    fi

    # Update Ghostty
    if [[ -f "$GHOSTTY_CONF" ]]; then
        sed -i '' 's/^theme = .*/'"$GHOSTTY"'/' "$GHOSTTY_CONF"
        echo "Updated Ghostty config"
    fi

    # Update tmux.conf
    if [[ -f "$TMUX_CONF" ]]; then
        sed -i '' 's/^set -g mode-style .*/'"$TMUX_MODE"'/' "$TMUX_CONF"
        sed -i '' 's/^set -g message-style .*/'"$TMUX_MSG"'/' "$TMUX_CONF"
        sed -i '' 's/^set -g message-command-style .*/'"$TMUX_MSG_CMD"'/' "$TMUX_CONF"
        sed -i '' 's/^set -g pane-border-style .*/'"$TMUX_PANE"'/' "$TMUX_CONF"
        sed -i '' 's/^set -g pane-active-border-style .*/'"$TMUX_PANE_ACTIVE"'/' "$TMUX_CONF"
        sed -i '' 's/^set -g status-style .*/'"$TMUX_STATUS"'/' "$TMUX_CONF"
        sed -i '' 's/^setw -g window-status-style .*/'"$TMUX_WIN"'/' "$TMUX_CONF"
        sed -i '' 's/^setw -g window-status-current-style .*/'"$TMUX_WIN_CUR"'/' "$TMUX_CONF"
        sed -i '' 's/^setw -g window-status-activity-style .*/'"$TMUX_WIN_ACT"'/' "$TMUX_CONF"
        echo "Updated tmux config"

        # Reload tmux if running
        if [[ -n "$TMUX" ]]; then
            tmux source-file "$TMUX_CONF" 2>/dev/null
            echo "Reloaded tmux"
        fi
    fi

    # Update zshrc FZF colors
    if [[ -f "$ZSHRC" ]]; then
        # Use perl for multi-line replacement
        perl -i -0pe 's/--color=bg\+:[^"]+"/'"$FZF"'/s' "$ZSHRC"
        echo "Updated FZF colors in zshrc"
    fi

    # Update nvim colorscheme
    if [[ -f "$NVIM_INIT" ]]; then
        sed -i '' 's/vim\.cmd\.colorscheme("[^"]*")/vim.cmd.colorscheme("'"$NVIM_SCHEME"'")/' "$NVIM_INIT"
        echo "Updated nvim colorscheme"
    fi

    echo ""
    echo "Theme switched to: $mode"
    echo ""
    echo "To complete the switch:"
    echo "  1. Restart Ghostty (or open new window)"
    echo "  2. Source your shell: source ~/.zshrc"
    echo "  3. Restart nvim (or run :colorscheme $NVIM_SCHEME)"
}

if [[ $# -ne 1 ]]; then
    usage
fi

switch_theme "$1"

#!/bin/bash

# Theme switcher for multiple colorschemes
# Updates: Ghostty, tmux, FZF (zshrc), and nvim

# Resolve symlinks (macOS sed -i doesn't work on symlinks)
resolve_path() {
    local file="$1"
    if [[ -L "$file" ]]; then
        local target
        target="$(readlink "$file")"
        if [[ "$target" == /* ]]; then
            echo "$target"
        else
            echo "$(dirname "$file")/$target"
        fi
    else
        echo "$file"
    fi
}

ZSHRC="$(resolve_path "$HOME/.zshrc")"
TMUX_CONF="$(resolve_path "$HOME/.tmux.conf")"
GHOSTTY_CONF="$(resolve_path "$HOME/.config/ghostty/config")"
NVIM_INIT="$(resolve_path "$HOME/.config/nvim/init.lua")"

SCHEMES=("tokyonight-day" "tokyonight-moon" "material-oceanic" "one-half-dark")

usage() {
    echo "Usage: theme <colorscheme>"
    echo ""
    echo "Available colorschemes:"
    for s in "${SCHEMES[@]}"; do
        echo "  $s"
    done
    exit 1
}

set_theme_vars() {
    case "$1" in
        tokyonight-day)
            GHOSTTY_THEME="tokyonight-day"
            TMUX_MODE='set -g mode-style "fg=#3760bf,bg=#b7c1e3"'
            TMUX_MSG='set -g message-style "fg=#3760bf,bg=#e1e2e7"'
            TMUX_MSG_CMD='set -g message-command-style "fg=#3760bf,bg=#e1e2e7"'
            TMUX_PANE='set -g pane-border-style "fg=#a1a6c5"'
            TMUX_PANE_ACTIVE='set -g pane-active-border-style "fg=#2e7de9"'
            TMUX_STATUS='set -g status-style "fg=#3760bf,bg=#e1e2e7"'
            TMUX_WIN='setw -g window-status-style "fg=#2e7de9,bg=#e1e2e7"'
            TMUX_WIN_CUR='setw -g window-status-current-style "fg=#e1e2e7,bg=#2e7de9"'
            TMUX_WIN_ACT='setw -g window-status-activity-style "fg=#e1e2e7,bg=#9854f1"'
            FZF='    --color=bg+:#b7c1e3,bg:#e1e2e7,spinner:#9854f1,hl:#f52a65 \
    --color=fg:#3760bf,header:#2e7de9,info:#2e7de9,pointer:#f52a65 \
    --color=marker:#007197,fg+:#3760bf,prompt:#f52a65,hl+:#f52a65 \
    --color=selected-bg:#b7c1e3 \
    --color=border:#a1a6c5,label:#3760bf"'
            NVIM_SCHEME="tokyonight-day"
            ;;
        tokyonight-moon)
            GHOSTTY_THEME="tokyonight-moon"
            TMUX_MODE='set -g mode-style "fg=#c8d3f5,bg=#2d3f76"'
            TMUX_MSG='set -g message-style "fg=#c8d3f5,bg=#222436"'
            TMUX_MSG_CMD='set -g message-command-style "fg=#c8d3f5,bg=#222436"'
            TMUX_PANE='set -g pane-border-style "fg=#444a73"'
            TMUX_PANE_ACTIVE='set -g pane-active-border-style "fg=#82aaff"'
            TMUX_STATUS='set -g status-style "fg=#c8d3f5,bg=#222436"'
            TMUX_WIN='setw -g window-status-style "fg=#82aaff,bg=#222436"'
            TMUX_WIN_CUR='setw -g window-status-current-style "fg=#222436,bg=#82aaff"'
            TMUX_WIN_ACT='setw -g window-status-activity-style "fg=#222436,bg=#c099ff"'
            FZF='    --color=bg+:#2d3f76,bg:#222436,spinner:#c099ff,hl:#ff757f \
    --color=fg:#c8d3f5,header:#82aaff,info:#82aaff,pointer:#ff757f \
    --color=marker:#86e1fc,fg+:#c8d3f5,prompt:#ff757f,hl+:#ff757f \
    --color=selected-bg:#2d3f76 \
    --color=border:#444a73,label:#c8d3f5"'
            NVIM_SCHEME="tokyonight-moon"
            ;;
        material-oceanic)
            GHOSTTY_THEME="material-oceanic"
            TMUX_MODE='set -g mode-style "fg=#eeffff,bg=#455a64"'
            TMUX_MSG='set -g message-style "fg=#b0bec5,bg=#1c262b"'
            TMUX_MSG_CMD='set -g message-command-style "fg=#b0bec5,bg=#1c262b"'
            TMUX_PANE='set -g pane-border-style "fg=#546e7a"'
            TMUX_PANE_ACTIVE='set -g pane-active-border-style "fg=#82aaff"'
            TMUX_STATUS='set -g status-style "fg=#b0bec5,bg=#1c262b"'
            TMUX_WIN='setw -g window-status-style "fg=#82aaff,bg=#1c262b"'
            TMUX_WIN_CUR='setw -g window-status-current-style "fg=#1c262b,bg=#82aaff"'
            TMUX_WIN_ACT='setw -g window-status-activity-style "fg=#1c262b,bg=#c792ea"'
            FZF='    --color=bg+:#455a64,bg:#1c262b,spinner:#c792ea,hl:#ff5370 \
    --color=fg:#b0bec5,header:#82aaff,info:#82aaff,pointer:#ff5370 \
    --color=marker:#89ddff,fg+:#eeffff,prompt:#ff5370,hl+:#ff5370 \
    --color=selected-bg:#455a64 \
    --color=border:#546e7a,label:#b0bec5"'
            NVIM_SCHEME="material"
            ;;
        one-half-dark)
            GHOSTTY_THEME=""
            TMUX_MODE='set -g mode-style "fg=#dcdfe4,bg=#474e5d"'
            TMUX_MSG='set -g message-style "fg=#dcdfe4,bg=#282c34"'
            TMUX_MSG_CMD='set -g message-command-style "fg=#dcdfe4,bg=#282c34"'
            TMUX_PANE='set -g pane-border-style "fg=#5d677a"'
            TMUX_PANE_ACTIVE='set -g pane-active-border-style "fg=#61afef"'
            TMUX_STATUS='set -g status-style "fg=#dcdfe4,bg=#282c34"'
            TMUX_WIN='setw -g window-status-style "fg=#61afef,bg=#282c34"'
            TMUX_WIN_CUR='setw -g window-status-current-style "fg=#282c34,bg=#61afef"'
            TMUX_WIN_ACT='setw -g window-status-activity-style "fg=#282c34,bg=#c678dd"'
            FZF='    --color=bg+:#474e5d,bg:#282c34,spinner:#c678dd,hl:#e06c75 \
    --color=fg:#dcdfe4,header:#61afef,info:#61afef,pointer:#e06c75 \
    --color=marker:#56b6c2,fg+:#dcdfe4,prompt:#e06c75,hl+:#e06c75 \
    --color=selected-bg:#474e5d \
    --color=border:#5d677a,label:#dcdfe4"'
            NVIM_SCHEME="onedark"
            ;;
        *)
            usage
            ;;
    esac
}

switch_theme() {
    local scheme=$1
    set_theme_vars "$scheme"

    # Update Ghostty
    if [[ -f "$GHOSTTY_CONF" ]]; then
        if [[ -z "$GHOSTTY_THEME" ]]; then
            # Default theme â€” remove the theme line
            sed -i '' '/^theme = /d' "$GHOSTTY_CONF"
        elif grep -q '^theme = ' "$GHOSTTY_CONF"; then
            sed -i '' 's/^theme = .*/theme = "'"$GHOSTTY_THEME"'"/' "$GHOSTTY_CONF"
        else
            # Theme line was removed (e.g. switching from default), add it back
            sed -i '' '1a\
theme = "'"$GHOSTTY_THEME"'"' "$GHOSTTY_CONF"
        fi
        echo "Updated Ghostty config"
    fi

    # Update tmux.conf
    if [[ -f "$TMUX_CONF" ]]; then
        sed -i '' 's/^set -g mode-style .*/'"$TMUX_MODE"'/' "$TMUX_CONF"
        sed -i '' 's/^set -g message-style .*/'"$TMUX_MSG"'/' "$TMUX_CONF"
        sed -i '' 's/^set -g message-command-style .*/'"$TMUX_MSG_CMD"'/' "$TMUX_CONF"
        sed -i '' 's/^set -g pane-border-style .*/'"$TMUX_PANE"'/' "$TMUX_CONF"
        sed -i '' 's/^set -g pane-active-border-style .*/'"$TMUX_PANE_ACTIVE"'/' "$TMUX_CONF"
        sed -i '' 's/^set -g status-style .*/'"$TMUX_STATUS"'/' "$TMUX_CONF"
        sed -i '' 's/^setw -g window-status-style .*/'"$TMUX_WIN"'/' "$TMUX_CONF"
        sed -i '' 's/^setw -g window-status-current-style .*/'"$TMUX_WIN_CUR"'/' "$TMUX_CONF"
        sed -i '' 's/^setw -g window-status-activity-style .*/'"$TMUX_WIN_ACT"'/' "$TMUX_CONF"
        echo "Updated tmux config"

        # Reload tmux if running
        if [[ -n "$TMUX" ]]; then
            tmux source-file "$TMUX_CONF" 2>/dev/null
            echo "Reloaded tmux"
        fi
    fi

    # Update zshrc FZF colors
    if [[ -f "$ZSHRC" ]]; then
        # Use perl for multi-line replacement
        perl -i -0pe 's/--color=bg\+:[^"]+"/'"$FZF"'/s' "$ZSHRC"
        echo "Updated FZF colors in zshrc"
    fi

    # Update nvim colorscheme
    if [[ -f "$NVIM_INIT" ]]; then
        sed -i '' 's/vim\.cmd\.colorscheme("[^"]*")/vim.cmd.colorscheme("'"$NVIM_SCHEME"'")/' "$NVIM_INIT"
        echo "Updated nvim colorscheme"
    fi

    echo ""
    echo "Theme switched to: $scheme"
    echo ""
    echo "To complete the switch:"
    echo "  1. Restart Ghostty (or open new window)"
    echo "  2. Source your shell: source ~/.zshrc"
    echo "  3. Restart nvim (or run :colorscheme $NVIM_SCHEME)"
}

if [[ $# -ne 1 ]]; then
    usage
fi

switch_theme "$1"
